<!DOCTYPE html>
<html lang="ko"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œê¸€ ìˆ˜ì •</title>
</head>
<main layout:fragment="content">
    <div class="container mt-5">
        <h2 class="mb-4">ê²Œì‹œíŒ - ìˆ˜ì •</h2>

        <form id="modifyForm" enctype="multipart/form-data">
            <input type="hidden" name="boardEngName" id="boardEngName">
            <table class="table table-bordered table-sm align-middle">
                <tbody>
                <tr>
                    <th class="ps-3 bg-light fw-semibold w-20">ì¹´í…Œê³ ë¦¬</th>
                    <td id="categoryName"></td>
                </tr>
                <tr>
                    <th class="ps-3 bg-light fw-semibold">ë“±ë¡ì¼ì‹œ</th>
                    <td><span id="createAt" class="dateTime"></span></td>
                </tr>
                <tr>
                    <th class="ps-3 bg-light fw-semibold">ìˆ˜ì •ì¼ì‹œ</th>
                    <td><span id="updateAt" class="dateTime"></span></td>
                </tr>
                <tr>
                    <th class="ps-3 bg-light fw-semibold">ì¡°íšŒìˆ˜</th>
                    <td><span id="views" class="views"></span></td>
                </tr>
                <tr>
                    <th class="ps-3 bg-light fw-semibold">ì‘ì„±ì <span class="text-danger">*</span></th>
                    <td>
                        <input type="text" name="writer" id="writer" class="form-control w-100">
                    </td>
                </tr>
                <tr>
                    <th class="ps-3 bg-light fw-semibold">ë¹„ë°€ë²ˆí˜¸ <span class="text-danger">*</span></th>
                    <td>
                        <input type="password" name="password" id="password" class="form-control w-100">
                    </td>
                </tr>
                <tr>
                    <th class="ps-3 bg-light fw-semibold">ì œëª© <span class="text-danger">*</span></th>
                    <td>
                        <input type="text" name="subject" id="subject" class="form-control w-100">
                    </td>
                </tr>
                <tr>
                    <th class="ps-3 bg-light fw-semibold">ë‚´ìš© <span class="text-danger">*</span></th>
                    <td>
                        <textarea name="content" id="content" rows="8" class="form-control w-100"></textarea>
                    </td>
                </tr>
                <tr>
                    <th class="ps-3 bg-light fw-semibold">ì²¨ë¶€íŒŒì¼</th>
                    <td>
                        <ul id="fileList" class="list-unstyled mb-0"></ul>
                    </td>
                </tr>
                <tr>
                    <th class="ps-3 bg-light fw-semibold">íŒŒì¼ ì²¨ë¶€</th>
                    <td>
                        <input type="file" name="files" id="files" class="form-control w-100" multiple>
                    </td>
                </tr>
                </tbody>
            </table>

            <div class="d-flex justify-content-end mt-3">
                <button type="button" class="btn btn-secondary me-2" id="cancelBtn">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn-primary">ì €ì¥</button>
            </div>
        </form>
    </div>
    <script>
        const postId = pathParts[pathParts.length - 1];

        loadPost(); // ì´ˆê¸° ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°

        // í¼ submit ì´ë²¤íŠ¸ â†’ ë¹„ë™ê¸° ì „ì†¡
        $('#modifyForm').submit((e) => {
            e.preventDefault();
            if (validatePostForm()) {
                submitForm();
            }
        });

        $('#cancelBtn').click(() => {
            window.location.href = withQueryString(`/boards/${boardEngName}/view/${postId}`);
        });

        function submitForm() {
            const formData = new FormData($('#modifyForm')[0]);

            axios.patch(`/api/v1/posts/${postId}`, formData)
                .then(res => {
                    alert("ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    window.location.href = withQueryString(`/boards/${boardEngName}/view/${postId}`);
                })
                .catch(err => {
                    if (err.response && err.response.status === 400 && err.response.data.errors) {
                        const messages = err.response.data.errors
                            .map(e => `- ${e.message}`)
                            .join('\n');
                        alert("ì…ë ¥ê°’ ì˜¤ë¥˜:\n" + messages);
                    } else {
                        alert("ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ë¡œ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                });
        }

        // í”„ë¡ íŠ¸ ìœ íš¨ì„± ê²€ì‚¬
        function validatePostForm() {
            const writer = $("#writer").val().trim();
            const password = $("#password").val();
            const subject = $("#subject").val().trim();
            const content = $("#content").val().trim();
            const files = $("#files")[0].files;

            const PASSWORD_REGEX = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[!@#$%^&*()\-_=+{}\[\]:;"'<>,.?/]).{4,16}$/;
            const MAX_FILE_SIZE = 10 * 1024 * 1024;
            const MAX_TOTAL_SIZE = 50 * 1024 * 1024;

            if (!writer || writer.length < 3 || writer.length >= 5) return alert("ì‘ì„±ìëŠ” 3ì ì´ìƒ 5ì ë¯¸ë§Œì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
            if (!password || !PASSWORD_REGEX.test(password)) return alert("ë¹„ë°€ë²ˆí˜¸ëŠ” 4~16ì, ì˜ë¬¸/ìˆ«ì/íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.");
            if (!subject || subject.length < 4 || subject.length >= 100) return alert("ì œëª©ì€ 4ì ì´ìƒ 100ì ë¯¸ë§Œì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
            if (!content || content.length < 4 || content.length >= 2000) return alert("ë‚´ìš©ì€ 4ì ì´ìƒ 2000ì ë¯¸ë§Œì´ì–´ì•¼ í•©ë‹ˆë‹¤.");

            let totalSize = 0;
            for (let i = 0; i < files.length; i++) {
                if (files[i].size > MAX_FILE_SIZE) return alert(`"${files[i].name}"ì€ 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                totalSize += files[i].size;
            }
            if (totalSize > MAX_TOTAL_SIZE) return alert("ì „ì²´ ì—…ë¡œë“œ ìš©ëŸ‰ì€ 50MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            return true;
        }

        function loadPost() {
            axios.get(`/api/v1/posts/${postId}`)
                .then(res => {
                    const data = res.data.data;
                    if (data.deleted) {
                        alert("ì‚­ì œëœ ê²Œì‹œê¸€ì€ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        window.location.href = withQueryString(`/boards/${boardEngName}/view/${postId}`);
                    }

                    $("#boardEngName").val(data.boardEngName);
                    $("#writer").val(data.writer);
                    $("#subject").val(data.subject);
                    $("#content").val(data.content);
                    $("#categoryName").text(data.categoryName);
                    $("#createAt").text(formatDateTime(data.createAt));
                    $("#updateAt").text(data.updateAt ? formatDateTime(data.updateAt) : '-');
                    $("#views").text(formatNumberWithComma(data.views));

                    const $fileList = $("#fileList");
                    $fileList.empty();
                    data.files.forEach(file => {
                        const $li = $(`
                        <li class="d-flex justify-content-between align-items-center border rounded px-3 py-2 mb-1">
                            <div>ğŸ“ <a href="/file/post/download?filename=${file.savedFilename}">${file.originalFilename}</a></div>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteFile('${file.savedFilename}', this)">X</button>
                            <input type="hidden" name="preserveFilenames" value="${file.savedFilename}">
                        </li>
                    `);
                        $fileList.append($li);
                    });
                })
                .catch(() => {
                    alert("ê²Œì‹œê¸€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                    window.location.href = withQueryString(`/boards/${boardEngName}/list`);
                });
        }

        function deleteFile(filename, btn) {
            $(btn).closest("li").remove();
        }
    </script>
</main>
</html>
